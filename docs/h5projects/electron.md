---
sidebar_position: 5
---

# H5 æ¡Œé¢ç«¯è½¯ä»¶

ç”±äºæµè§ˆå™¨çš„é™åˆ¶ï¼ŒH5 é¡µé¢ä¸èƒ½å¤Ÿä½¿ç”¨ Tcp/Socket åè®®æ¥å’Œæ§åˆ¶å™¨è¿›è¡Œé€šè®¯ï¼Œèƒ½å¤Ÿä½¿ç”¨çš„é€šè®¯åè®®åªæœ‰ websocketï¼Œå¦‚æœä¸æ§åˆ¶å™¨è¿›è¡Œé€šè®¯åˆ™éœ€è¦ç¬¬ä¸‰æ–¹ç¨‹åºè¿›è¡Œè½¬å‘ï¼Œå¾ˆéº»çƒ¦ï¼Œè€Œä¸”é€šè®¯æ•ˆç‡å¾ˆä½ã€‚

äºæ˜¯æˆ‘ä»¬æƒ³åˆ°å°† H5 é¡µé¢æ‰“åŒ…æˆä¸€ä¸ªæ¡Œé¢ç«¯çš„è½¯ä»¶ï¼Œè¿™æ ·å°±è·³å‡ºäº†æµè§ˆå™¨çš„é™åˆ¶ï¼Œä½¿ç”¨åŸç”Ÿçš„ Tcp/Socket è¿›è¡Œé€šè®¯ã€‚

## NexDroid æ¡Œé¢è°ƒè¯•è½¯ä»¶

æˆ‘ä»¬æ­£åœ¨å°è¯•å¼€å‘ä¸€ä¸ªç®€æ˜“çš„æœºå™¨äººå‚æ•°è°ƒè¯•è½¯ä»¶ï¼Œç”¨æ¥éªŒè¯ä¸Šé¢æƒ³æ³•çš„å¯è¡Œæ€§ã€‚

[è¯•ç”¨ä¸‹è½½](https://inexbot-use.oss-cn-shanghai.aliyuncs.com/pc-debugger/version/NexDroid%E6%A1%8C%E9%9D%A2%E8%B0%83%E8%AF%95%20Setup%200.1.3.exe)

<img src="/img/h5projects/pcdebugger1.png" align="center" />

### æŠ€æœ¯æ ˆ

- [React - ç”¨äºæ„å»ºç”¨æˆ·ç•Œé¢çš„ JavaScript åº“](https://react.docschina.org/)
- [UmiJs - ğŸ™ æ’ä»¶åŒ–çš„ä¼ä¸šçº§å‰ç«¯åº”ç”¨æ¡†æ¶ã€‚](https://umijs.org/zh-CN)
- [Electron - ä½¿ç”¨ JavaScriptï¼ŒHTML å’Œ CSS æ„å»ºè·¨å¹³å°çš„æ¡Œé¢åº”ç”¨ç¨‹åº](https://www.electronjs.org/)
- [DvaJs - dva æ˜¯ä¸€ä¸ªåŸºäº redux å’Œ redux-saga çš„æ•°æ®æµæ–¹æ¡ˆ](https://dvajs.com/)
- [Ant Design - ä¼ä¸šçº§äº§å“è®¾è®¡ä½“ç³»ï¼Œåˆ›é€ é«˜æ•ˆæ„‰æ‚¦çš„å·¥ä½œä½“éªŒ](https://ant.design/index-cn)
- [Ant Design Charts - ç®€å•å¥½ç”¨çš„ React å›¾è¡¨åº“](https://charts.ant.design/zh-CN)

### å®ç°åŸç†

ä½¿ç”¨ Electron å°†ç½‘é¡µç¨‹åºæ‰“åŒ…æˆå¯æ‰§è¡Œç¨‹åºã€‚å½“è¿è¡Œçš„æ—¶å€™ä¼šæœ‰ä¸¤ä¸ªè¿›ç¨‹ï¼Œä¸»è¿›ç¨‹ä¸æ¸²æŸ“è¿›ç¨‹ã€‚

æ‰€è°“çš„æ¸²æŸ“è¿›ç¨‹ï¼Œå°±æ˜¯é¡µé¢æ˜¾ç¤ºçš„è¿›ç¨‹ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæµè§ˆå™¨å®¢æˆ·ç«¯çš„è¿›ç¨‹ã€‚ä¸»è¿›ç¨‹å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæœåŠ¡ç«¯æˆ–è€…åç«¯è¿›ç¨‹ã€‚

å½“é¡µé¢éœ€è¦ä¸æœºå™¨äººæ§åˆ¶å™¨è¿›è¡Œé€šè®¯æ—¶ï¼Œå…¶æµç¨‹å¦‚ä¸‹ï¼š

`æ¸²æŸ“è¿›ç¨‹->è¿›ç¨‹é—´é€šè®¯->ä¸»è¿›ç¨‹->Tcp->æœºå™¨äººæ§åˆ¶å™¨`

ä»¥ä¸Šé€šè®¯åŸç†åœ¨ Electron çš„`ipcMain`ã€`ipcRenderer`ç­‰æ¨¡å—ä¸­å¯ä»¥æ‰¾åˆ°ã€‚

### é€šè®¯åè®®

é‰´äºè‹¥è¦ç»„æˆ NexDroid æ§åˆ¶ç³»ç»Ÿæ•°æ®æ®µæ¯”è¾ƒå¤æ‚ï¼Œä¸‹é¢å…¬å¼€ javascript è¯­è¨€ä¸­ç»„æˆå’Œè§£ææ•°æ®æ®µçš„å‡½æ•°ã€‚

#### ç»„è£…æ•°æ®æ®µ

è¯¥æ–¹æ³•éœ€è¦å¼•ç”¨ä¸¤ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œ[crc32](https://www.npmjs.com/package/crc32)ã€[utf-8](https://www.npmjs.com/package/utf-8)

`npm install crc32 utf-8`

```javascript
var crc32 = require("crc32");
var utf8 = require("utf-8");
```

å‘é€å¯¹è±¡æ•°æ®

```javascript
//å‘é€æ•°æ®ï¼Œcommandä¸ºå‘½ä»¤å­—ï¼Œæ ¼å¼ä¸ºintï¼Œå¦‚0xFF12ï¼Œdataä¸ºå¯¹è±¡ï¼Œå¦‚{"robot":1}
function AssemblyData(command, data) {
  var dataLength;
  var dataString = JSON.stringify(data);
  var dataBuffer = new Uint8Array(utf8.setBytesFromString(dataString));
  dataLength = data ? dataBuffer.byteLength : 0;
  var headerBuffer = Buffer.from([0x4e, 0x66]);
  var lengthBuffer = Buffer.alloc(2);
  lengthBuffer.writeIntBE(dataLength, 0, 2);
  var commandBuffer = Buffer.alloc(2);
  commandBuffer.writeUIntBE(command, 0, 2);
  var toCrc32 = Buffer.concat([lengthBuffer, commandBuffer, dataBuffer]);
  var crc32Buffer = crc32(toCrc32);
  var message = Buffer.concat([
    headerBuffer,
    lengthBuffer,
    commandBuffer,
    dataBuffer,
    crc32Buffer,
  ]);
  return message;
}
```

å‘é€æ–‡ä»¶ Buffer æ•°æ®

```javascript
//dataç±»å‹ä¸ºbuffer
function AssemblyData(command, data) {
  var dataLength;
  var dataBuffer = data;
  dataLength = dataBuffer.byteLength;
  var headerBuffer = Buffer.from([0x4e, 0x66]);
  var lengthBuffer = Buffer.alloc(2);
  lengthBuffer.writeIntBE(dataLength, 0, 2);
  var commandBuffer = Buffer.alloc(2);
  commandBuffer.writeUIntBE(command, 0, 2);
  var toCrc32 = Buffer.concat([lengthBuffer, commandBuffer, dataBuffer]);
  var crc32Buffer = crc32(toCrc32);
  var message = Buffer.concat([
    headerBuffer,
    lengthBuffer,
    commandBuffer,
    dataBuffer,
    crc32Buffer,
  ]);
  return message;
}
```

#### è§£ææ•°æ®

Tcp æ¥æ”¶æ•°æ®ä¼šå¶æœ‰é»åŒ…é—®é¢˜ï¼Œè‹¥è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦å°†æ‰€æœ‰æ¥æ”¶æ•°æ®æ”¾åœ¨ä¸€ä¸ªå¤§çš„ Buffer ä¸­ï¼Œå†ä¸€ä¸ªä¸ªè§£æã€‚

```javascript
var bigBuffer = Buffer.alloc(0);
//æ¥æ”¶äº‹ä»¶
socket.on("data",(buffer)=>{
    receiveBuffer(buffer);
})
//å°†æ–°æ¥æ”¶æ•°æ®æ”¾åœ¨bigBufferä¸­ï¼Œç„¶åå¼€å§‹å¤„ç†
function receiveBuffer(buffer) {
  bigBuffer = Buffer.concat([bigBuffer, buffer]);
  handleReviceBuffer(bigBuffer)
}
//å¤„ç†å¤§Buffer
function handleReviceBuffer(buffer) {
  var index = buffer.indexOf('Nf');
  if (index == -1) {
    return;
  }
  var lengthBuffer = buffer.slice(index + 2, index + 4);
  var length = lengthBuffer.readUIntBE(0, 2);
  var newBuffer = buffer.slice(index, index + 2 + 2 + 2 + length + 4);
  if (newBuffer.length < index + 2 + 2 + 2 + length + 4) {
    return;
  }
  bigBuffer = buffer.slice(index + 2 + 2 + 2 + length + 4);
  handleBuffer(newBuffer);
  handleReviceBuffer(bigBuffer);
}
//è§£ææ•°æ®
function handleBuffer(buffer) {
  var commandBuffer = buffer.slice(4, 6);
  var dataBuffer = buffer.slice(6, buffer.length - 4);
  var commandInt = commandBuffer.readUIntBE(0, 2);
  //0x5521æ˜¯æ¥æ”¶æ–‡ä»¶Bufferæ•°æ®çš„å‘½ä»¤å­—
  if (commandInt == 0x5521) {
    handleReceiveMessage(commandInt, dataBuffer);
    return;
  }
  //0x5522æ˜¯æ¥æ”¶æ–‡ä»¶çš„åˆ¤æ–­æˆåŠŸå‘½ä»¤å­—
  if (commandInt == 0x5522) {
    handleReceiveMessage(commandInt, '');
    return;
  }
  var dataString = dataBuffer.toString();
  var dataJSON = JSON.parse(dataString);
  handleReceiveMessage(commandInt, dataJSON);
}
handleReceiveMessage(command,data){
  //do sth to command and data
}
```

### ç¤ºæ³¢å™¨

æˆ‘ä»¬å°è¯•åšäº†ä¸€ä¸ªç¤ºæ³¢å™¨åŠŸèƒ½ã€‚æœ¬æ¥æˆ‘ä»¬æƒ³è¦å®æ—¶æ˜¾ç¤ºå½“å‰æ•°æ®æ³¢å½¢ï¼Œä½†æ˜¯å‘ç°ç”±äºæ€§èƒ½åŸå› ï¼Œå¡é¡¿ä¸¥é‡ã€‚äºæ˜¯æˆ‘ä»¬é‡‡å–äº†å…ˆé‡‡é›†æ•°æ®ï¼Œç„¶åæ ¹æ®éœ€æ±‚æ˜¾ç¤ºçš„å½¢å¼ï¼Œå®Œå…¨å¯ä»¥å®ç°é‡‡æ ·å‘¨æœŸ 10msï¼Œé‡‡æ ·ç‚¹æ•° 2000 ä¸ªçš„æ ‡å‡†ã€‚

å½“å‰å¯ä»¥åŒæ—¶é‡‡é›†å…³èŠ‚è½´åæ ‡å€¼ã€è½´é€Ÿåº¦ã€è½´åŠ é€Ÿåº¦ã€ç”µæœºåŠ›çŸ©ã€ç”µæœºç”µæµç­‰å‚æ•°ï¼Œå†æ ¹æ®éœ€è¦é€‰æ‹©å¹¶ç»˜åˆ¶ï¼Œä¸éœ€è¦ä¸åŒå‚æ•°é‡å¤é‡‡é›†ã€‚

æ•°æ®é‡‡é›†ä½¿ç”¨çš„ NexDroid ç³»ç»Ÿæä¾›çš„ 7000 ç«¯å£ã€‚å›¾è¡¨ç»˜åˆ¶å‡ºäºæ–¹ä¾¿é‡‡ç”¨äº†[Ant Design Charts](https://charts.ant.design/)

<img src="/img/h5projects/pcdebugger2.png" align="center" />

### ä»£ç ç¼–è¾‘

PC ç‰ˆè°ƒè¯•è½¯ä»¶é›†æˆäº†ä¸€ä¸ªç®€æ˜“çš„ä»£ç ç¼–è¾‘å™¨åŠŸèƒ½ï¼Œå¯ä»¥è§£æ<strong>lua</strong>è„šæœ¬æ–‡ä»¶å’Œ NexDroid ç³»ç»Ÿçš„ç¨‹åºæ–‡ä»¶<strong>JBR</strong>æ ¼å¼ã€‚

è¯¥ä»£ç ç¼–è¾‘å™¨ä½¿ç”¨äº†å¾®è½¯å…¬å¸çš„[Monaco Editor](https://microsoft.github.io/monaco-editor/)

<img src="/img/h5projects/pcdebugger3.png" align="center" />
